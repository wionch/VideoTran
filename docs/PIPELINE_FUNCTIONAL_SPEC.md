# 高性能视频字幕提取流水线 - 功能说明文档

## 1. 概述

本项目是一个高性能、全自动的视频字幕提取流水线。其核心目标是接收一个视频文件作为唯一输入，通过一系列高度优化的处理阶段，最终输出一个包含精确时间轴和位置信息的高精度字幕文件（JSON格式）。

该流水线基于工业级方案进行设计和重构，旨在最大化利用硬件性能（特别是GPU），并实现从视频到字幕的端到端自动化。

## 2. 核心特性

- **全自动处理**: 无需提供任何初始字幕文件或手动指定字幕区域。流水线会自动分析视频内容，智能定位字幕并提取。
- **高性能**: 深度利用GPU进行视频解码、图像计算和文字识别（OCR），并采用高效算法（如dHash）和批处理机制来保证处理速度。
- **高精度时间轴**: 通过先进的变化检测算法，能精确到帧级别地捕捉字幕的出现、变化和消失，从而生成精确的开始和结束时间。
- **高鲁棒性**: 内置的算法（如用于空白帧检测的大津法自动阈值）能够自适应不同的视频光照、内容和风格，保证了在多种视频源下的稳定表现。
- **模块化设计**: 整个流水线被拆分为五个独立的、可配置的模块，使得维护、升级和单独测试变得简单高效。

## 3. 工作流程（流水线阶段）

流水线通过五个核心阶段将视频转换为结构化字幕数据：

#### **阶段一：GPU视频解码 (`GPUDecoder`)**

- **功能**: 此阶段是整个流水线的入口。它使用高性能的`PyAV`库直接从视频文件中解码出视频帧，并高效地将它们加载到GPU显存中，为后续的并行处理做好准备。
- **优势**: 相比传统的CPU解码，GPU解码速度更快，且避免了数据在CPU和GPU之间的频繁传输，从源头上保证了高性能。

#### **阶段二：智能字幕区域检测 (`SubtitleAreaDetector`)**

- **功能**: 此阶段实现了“全自动”的核心。它会自动从视频中采样数百帧图像，利用内置的AI文本检测模型快速扫描这些帧中的所有文字位置。然后，通过统计和聚类算法，精确地计算出字幕最常出现的、最稳定的屏幕区域。
- **优势**: 彻底摆脱了对外部输入的依赖。无论视频来源如何，无论字幕在屏幕上方还是下方，都能准确锁定处理区域。

#### **阶段三：高效变化检测 (`ChangeDetector`)**

- **功能**: 在确定字幕区域后，此阶段负责逐帧分析该区域，以找出字幕发生变化的每一个“关键帧”。它创新地结合了两种算法：
    1.  **dHash (差异哈希)**: 为每个字幕区域生成一个紧凑的“指纹”。通过比较相邻帧的指纹差异（汉明距离），可以快速捕捉到文字内容的变化。
    2.  **像素标准差**: 计算字幕区域的像素复杂度。通过此指标可以精确判断一帧是“空白”（无字幕）还是“非空白”（有字幕）。
- **优势**: 这种混合方法既快速又准确。同时，它使用大津法（Otsu's Method）自动计算空白画面的判断阈值，使其能自动适应不同视频的亮度和对比度。

#### **阶段四：批量OCR识别 (`BatchOCREngine`)**

- **功能**: 此阶段是性能的另一个关键。它接收上一阶段找出的所有“关键帧”，将它们收集起来，然后**一次性**地送入PaddleOCR引擎进行文字识别。
- **优势**: 批量处理的速度远快于一帧一帧地进行识别。这极大地缩短了整个流程中最耗时的OCR步骤所需的时间。

#### **阶段五：字幕后处理 (`SubtitlePostprocessor`)**

- **功能**: 这是流水线的最后一站。它负责将OCR返回的、离散的文本结果，智能地“缝合”成连续的、带有精确起止时间的字幕片段。
- **优势**: 它会自动合并内容相同的连续片段，过滤掉持续时间过短的零碎识别结果（通常是噪声），并最终整理输出为结构清晰、随时可用的JSON格式。

## 4. 使用方法

### 4.1. 命令格式

通过`run_pipeline.py`脚本启动流水线。最简化的调用方式如下：

```bash
python run_pipeline.py --video_input "路径/到/你的/视频.mp4"
```

### 4.2. 参数说明

- `-i`, `--video_input` (必需): 要处理的视频文件的完整路径。
- `-o`, `--output_dir` (可选): 指定输出的JSON字幕文件的存放目录。如果省略，则默认保存在与输入视频相同的目录下。
- `--config` (可选): 指定一个自定义的YAML配置文件路径，用于调整流水线各模块的内部参数。

### 4.3. 输出文件

流水线成功运行后，会生成一个与视频文件同名，但后缀为`.precise.json`的字幕文件。

其数据结构如下：

```json
[
    {
        "id": 1,
        "startTime": 10.542,
        "endTime": 12.875,
        "text": "Hello, world.",
        "bbox": [
            [160, 620],
            [1120, 620],
            [1120, 680],
            [160, 680]
        ]
    },
    ...
]
```

- `id`: 字幕的顺序编号。
- `startTime`: 字幕出现的开始时间（单位：秒）。
- `endTime`: 字幕消失的结束时间（单位：秒）。
- `text`: 识别出的字幕文本内容。
- `bbox`: 字幕在视频帧中的位置坐标 `[[x1,y1], [x2,y1], [x2,y2], [x1,y2]]`。

## 5. 高级配置

对于高级用户，可以通过编写一个YAML配置文件，并使用`--config`参数加载它，来精细地调整流水线各阶段的行为。例如，可以调整采样帧数、dHash的敏感度、OCR识别语言等。如果未提供配置文件，系统将使用一套通用性良好的默认配置。
